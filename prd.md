# PRD: Shadowing YouTube - 유튜브 기반 영어 학습 서비스

## 1. 개요

### 1.1 제품 요약
YouTube 영상의 자막(스크립트)을 활용하여 문장 단위로 영어를 학습할 수 있는 웹 애플리케이션. 사용자가 YouTube 링크를 입력하면 자막을 추출하고, AI가 전체 문맥을 파악하여 번역 및 표현 분석을 사전 생성한 뒤 파일로 저장한다. 이후 학습 화면에서는 저장된 파일만 읽어 표시하므로 실시간 AI 호출 없이 동작한다.

### 1.2 목표
- YouTube 영상을 활용한 실전 영어 학습 환경 제공
- 문장 단위 자막 탐색 및 반복 학습 지원
- 사전 생성된 번역/표현 해설로 빠르고 비용 효율적인 학습 경험 제공
- 쉐도잉 연습을 통한 스피킹 능력 향상

### 1.3 대상 사용자
- 영어를 공부하는 한국어 사용자
- 유튜브 콘텐츠를 활용해 재미있게 영어를 배우고 싶은 학습자
- 쉐도잉, 딕테이션 등 능동적 학습법을 선호하는 학습자

---

## 2. 핵심 아키텍처: 사전 생성 파일 기반

### 2.1 처리 흐름

```
[사용자: 웹에서 YouTube URL 입력]
        ↓
[Step 1] 웹 서버가 자막 추출 (youtube-transcript-plus)
        ↓
[Step 2] XXX_script.txt 저장 (타임스탬프 + 영어 원문)
        ↓
[Step 3] 사용자가 터미널에서 npm run translate <youtubeId> 실행
        ↓
[Step 4] 스크립트를 4개 청크로 분할
        ↓
[Step 5] Claude CLI가 번역(4청크) + 표현 분석(4청크) = 최대 8개 프로세스 병렬 실행
        ↓
[Step 6] 결과 병합 → XXX_script_translate.txt + XXX_script_analysis.json 저장
        ↓
[학습 화면] 저장된 파일 3개를 읽어서 UI 표시 (AI 호출 없음)
```

> **설계 변경**: 번역/분석을 서버사이드 API 호출 대신 Claude Code CLI (`claude -p`)로 처리.
> 별도 AI API 키 없이 로컬 Claude CLI만으로 동작한다.
> 자막을 청크로 분할하여 번역과 분석을 병렬 실행함으로써 처리 속도를 대폭 개선하였다.

### 2.2 파일 구조

영상별로 아래 3개 파일을 생성하여 `data/videos/{youtubeId}/` 디렉토리에 저장한다.

#### `{youtubeId}_script.txt`
```
[00:00:00.480 --> 00:00:02.760] If either of us wins, we split the prize.
[00:00:02.760 --> 00:00:05.279] Sounds like a deal.
[00:00:05.279 --> 00:00:06.960] Hey, Judy, take a break. I'll check the bike for you.
...
```
- 타임스탬프는 밀리초 단위까지 보존 (`HH:MM:SS.mmm`)
- 인접 자막 간 겹침 보정: 각 라인의 endTime을 다음 라인의 startTime으로 클램프
- YouTube HTML 엔티티 (`&amp;#39;` 등) 디코딩 처리

#### `{youtubeId}_script_translate.txt`
```
[1] 우리가 이기면 상금을 나눠 가지자.
[2] 괜찮은 거래 같군.
[3] 주디, 좀 쉬어. 내가 자전거 확인해줄게.
...
```
- 각 라인은 `_script.txt`의 라인 번호와 1:1 대응
- AI가 번역 시 앞뒤 문맥을 함께 파악하여 자연스러운 번역 생성
- 이상한 자막(잘린 문장, 오타 등)은 앞뒤 라인을 참고하여 보정

#### `{youtubeId}_script_analysis.json`
```json
[
  {
    "line": 1,
    "keyExpressions": [
      {
        "expression": "split the prize",
        "meaning": "상금을 나누다",
        "explanation": "두 명 이상이 상금이나 이익을 동등하게 나눌 때 사용합니다.",
        "example": "If we win the lottery, we'll split the prize.",
        "highlightColor": "green"
      }
    ],
    "idioms": [
      {
        "expression": "Sounds like a deal",
        "meaning": "좋아요, 콜!",
        "explanation": "제안이 아주 마음에 들거나 동의할 때 쓰는 표현",
        "example": "You'll do my laundry for a week? Sounds like a deal.",
        "highlightColor": "yellow"
      }
    ]
  },
  {
    "line": 2,
    "keyExpressions": [],
    "idioms": []
  }
]
```

### 2.3 번역 품질 보장 전략

AI에게 번역을 요청할 때 아래 규칙을 적용:

1. **청크 단위 병렬 처리**: 전체 자막을 4개 청크로 분할하여 각 청크별로 병렬 번역 (각 청크 내에서 문맥 파악)
2. **앞뒤 라인 참조**: 특정 라인이 이상하면(잘린 문장, 의미 불분명) 앞뒤 1~2줄을 함께 고려
3. **자연스러운 한국어**: 직역이 아닌 의역 중심, 구어체 반영
4. **일관된 번역**: 같은 캐릭터의 말투, 반복 등장하는 용어는 일관성 유지

---

## 3. 핵심 기능

### 3.1 YouTube 링크 입력 및 자막 추출

| 항목 | 설명 |
|------|------|
| 입력 | YouTube URL |
| 처리 | YouTube 자막(CC/스크립트) 데이터 추출 |
| 출력 | `{youtubeId}_script.txt` 파일 생성 |

- 사용자가 YouTube URL을 입력하면 해당 영상의 자막을 자동으로 가져온다.
- 자막이 없는 영상의 경우 안내 메시지를 표시한다.
- 자막 언어는 영어(en)를 기본으로 한다.
- 이미 처리된 영상(파일이 존재하는 경우)은 재처리 없이 바로 학습 화면으로 이동한다.
- 자막 추출 시 처리:
  - HTML 엔티티 디코딩 (`&amp;#39;` → `'`, `&quot;` → `"` 등)
  - 인접 자막 타임스탬프 겹침 보정 (endTime을 다음 라인 startTime으로 클램프)
  - 밀리초 단위 정밀도 보존

### 3.2 메인 영상 플레이어 (좌측 영역, 화면의 약 70%)

- YouTube iframe embed를 통한 영상 재생
- 영상 하단에 현재 문장의 자막 오버레이 표시
  - **영어 원문**: 핵심 표현은 색상으로 하이라이트 (초록: 핵심표현, 노랑: 관용표현)
  - **한국어 번역**: 영어 원문 아래에 표시
- **원문 보기** / **번역 보기** 토글 버튼 제공
- 현재 재생 시간에 맞는 자막 라인을 `_script.txt`에서 매칭하여 표시

### 3.3 재생 컨트롤 (하단 영역)

| 버튼 | 단축키 | 동작 |
|------|--------|------|
| 이전 | 1 | 이전 자막 문장으로 이동 |
| 일시정지 | 2 | 영상 일시정지/재생 토글 |
| 문장 반복 | 3 | 현재 문장 구간 반복 재생 |
| 다음 | 4 | 다음 자막 문장으로 이동 |

- 키보드 단축키(1, 2, 3, 4)를 통한 빠른 조작 지원
- 문장 단위로 영상의 특정 구간을 탐색하며 학습 가능
- **자막 싱크 오프셋 조절**: ±0.5초 단위로 전체 자막 타이밍을 앞/뒤로 조절 가능 (구현 완료)

### 3.4 문장 해석 패널 (우측 영역 - 문장해석 탭)

현재 재생 중인 자막 문장에 대한 상세 해석을 제공하는 핵심 학습 영역.
모든 데이터는 사전 생성된 파일(`_translate.txt`, `_analysis.json`)에서 읽어온다.

#### 3.4.1 현재 문장 표시
- 영어 원문 (핵심 표현 하이라이트 - `_analysis.json`의 highlightColor 참조)
- 한국어 번역 (`_translate.txt`에서 해당 라인 읽기)

#### 3.4.2 핵심 표현
- `_analysis.json`의 `keyExpressions` 데이터 표시
- 각 표현: 한국어 의미, 사용 맥락 설명, 예문

#### 3.4.3 관용 표현
- `_analysis.json`의 `idioms` 데이터 표시
- 각 표현: 한국어 의미, 상세 설명, 예문

#### 3.4.4 탐색 기능
- 이전 번역 / 다음 번역 네비게이션
- 다음 자막 문장 미리보기

#### 3.4.5 학습 보조 기능
- **저장**: 해당 문장/표현을 북마크하여 나중에 복습
- **반복재생**: 현재 문장 구간 반복 재생

### 3.5 AI 탭

- AI 채팅 인터페이스를 통한 자유로운 질문
- 현재 자막 문장에 대한 추가 질문 가능 (문법, 유사 표현, 발음 등)
- **이 탭만 실시간 AI 호출 필요** (나머지는 파일 기반)

### 3.6 쉐도잉 탭

- 현재 문장을 듣고 따라 말하는 쉐도잉 연습 기능
- 마이크 입력을 통한 사용자 음성 녹음
- 원본 음성과 사용자 음성 비교 (선택적)

### 3.7 요약/퀴즈 탭

- 영상 전체 내용 요약 제공 (사전 생성 가능)
- 학습한 표현 기반 퀴즈 (빈칸 채우기, 의미 맞추기, 영작 등)

### 3.8 자막 싱크 탭 (구현 완료)

- 전체 자막 목록을 타임라인 형태로 표시
- 특정 자막 클릭 시 해당 시점으로 영상 이동
- 현재 재생 중인 자막 자동 하이라이트 및 스크롤
- **자막 싱크 수동 조정**: 하단 컨트롤 바에서 ±0.5초 단위로 오프셋 조절 (구현 완료)

### 3.9 드릴 시트

- 학습한 표현들을 모아 반복 학습하는 별도 페이지
- 저장한 핵심 표현/관용 표현 목록
- 외부 링크 또는 새 탭으로 이동

---

## 4. 페이지 구성

### 4.1 랜딩 페이지 (홈)
- YouTube URL 입력 필드 (중앙 배치, 심플한 디자인)
- 최근 학습한 영상 목록 (Phase 2)
- 서비스 소개 문구

### 4.2 학습 페이지 (메인)
```
┌─────────────────────────────────┬──────────────────┐
│                                 │ [탭: 문장해석|AI|쉐도잉|요약퀴즈|자막싱크] │
│                                 │                  │
│     YouTube 영상 (iframe)       │  ← 이전 번역      │
│                                 │                  │
│                                 │  ★ 현재          │
│   ┌───────────────────────┐     │  영어 원문 (하이라이트)│
│   │ 영어 자막 (하이라이트)   │     │  한국어 번역       │
│   │ 한국어 번역             │     │                  │
│   └───────────────────────┘     │  📖 핵심 표현      │
│                                 │  ...             │
│   [원문 보기] [번역 보기]         │  🔄 관용 표현      │
│                                 │  ...             │
├─────────────────────────────────│  [저장] [반복재생]  │
│ [이전|1] [일시정지|2] [반복|3] [다음|4] │                  │
│                                 │  → 다음 번역       │
│                                 │  [드릴 시트]       │
└─────────────────────────────────┴──────────────────┘
```

### 4.3 드릴 시트 페이지
- 저장한 표현 목록
- 반복 학습 인터페이스

---

## 5. 기술 스택

### 5.1 프론트엔드
| 구분 | 기술 |
|------|------|
| 프레임워크 | Next.js (App Router) |
| 언어 | TypeScript |
| 스타일링 | Tailwind CSS |
| 상태 관리 | Zustand |
| YouTube 연동 | YouTube IFrame Player API |

### 5.2 백엔드
| 구분 | 기술 |
|------|------|
| API | Next.js API Routes (Route Handlers) |
| 자막 추출 | youtube-transcript-plus 라이브러리 |
| AI 번역/분석 | Claude Code CLI (`claude -p`) - 청크 분할 병렬 처리, 별도 API 키 불필요 |
| 파일 저장 | 서버 로컬 파일시스템 (`data/videos/{youtubeId}/`) |
| 데이터베이스 | SQLite 또는 Supabase (북마크, 사용자 데이터 - Phase 2) |

### 5.3 인프라
| 구분 | 기술 |
|------|------|
| 배포 | Vercel |
| 파일 스토리지 | Vercel Blob 또는 Supabase Storage (배포 시) |

---

## 6. API 엔드포인트

### 6.1 영상 처리 API

#### `POST /api/videos/process`
- 요청: `{ youtubeUrl: string }`
- 동작:
  1. YouTube ID 추출
  2. 이미 처리된 영상인지 확인 (파일 3개 존재 여부)
  3. 미처리 시: 자막 추출 → `_script.txt`만 저장
  4. 번역/분석 파일이 없으면 `needsProcessing: true` 반환 (CLI 안내)
  5. 모든 파일 존재 시: 바로 학습 가능
- 응답: `{ youtubeId, title, subtitleCount, isNew, needsProcessing?, message? }`

### 6.2 학습 데이터 API

#### `GET /api/videos/{youtubeId}/script`
- `_script.txt` 파일을 파싱하여 JSON 배열로 반환
- 응답: `[{ line, startTime, endTime, text }]`

#### `GET /api/videos/{youtubeId}/translate`
- `_script_translate.txt` 파일을 파싱하여 JSON 배열로 반환
- 응답: `[{ line, translation }]`

#### `GET /api/videos/{youtubeId}/analysis`
- `_script_analysis.json` 파일을 그대로 반환
- 응답: `[{ line, keyExpressions, idioms }]`

#### `GET /api/videos/{youtubeId}/data`
- 위 3개를 합쳐서 한 번에 반환 (프론트 편의용)
- 응답: `[{ line, startTime, endTime, text, translation, keyExpressions, idioms }]`

---

## 7. AI 프롬프트 설계

### 7.1 번역 프롬프트

```
당신은 영어-한국어 전문 번역가입니다. 아래 YouTube 영상의 영어 자막을 한국어로 번역해주세요.

[규칙]
1. 전체 문맥을 파악한 뒤 번역하세요.
2. 특정 라인이 잘리거나 이상한 경우, 앞뒤 라인을 참고하여 자연스러운 문장으로 보정하세요.
3. 직역보다 자연스러운 의역을 우선하되, 원래 의미를 왜곡하지 마세요.
4. 같은 인물의 말투는 일관되게 유지하세요.
5. 각 라인 번호에 맞춰 번역을 출력하세요.

[영상 정보]
제목: {title}
채널: {channel}

[자막]
{전체 스크립트}
```

### 7.2 표현 분석 프롬프트

```
당신은 영어 교육 전문가입니다. 아래 영어 자막의 각 문장에서 한국인 영어 학습자에게 유용한
핵심 표현과 관용 표현을 추출해주세요.

[규칙]
1. 모든 문장에 표현이 있는 것은 아닙니다. 없으면 빈 배열로 처리하세요.
2. 핵심 표현: 일상에서 자주 쓰이는 유용한 표현, 구동사(phrasal verb), 콜로케이션 등
3. 관용 표현: 숙어(idiom), 속담, 비유적 표현 등
4. 각 표현에 대해 한국어 의미, 간단한 설명, 예문을 포함하세요.
5. JSON 형식으로 출력하세요.

[자막]
{전체 스크립트}
```

---

## 8. 개발 단계

### Phase 1 - MVP (핵심 학습 기능)
- [x] 랜딩 페이지: YouTube URL 입력
- [x] YouTube 자막 추출 → `_script.txt` 저장
- [x] Claude CLI 번역 → `_script_translate.txt` 저장 (`npm run translate`)
- [x] Claude CLI 표현 분석 → `_script_analysis.json` 저장 (`npm run translate`)
- [x] 학습 페이지: YouTube iframe 임베드
- [x] 자막 오버레이 (영어 원문 + 한국어 번역 + 하이라이트)
- [x] 문장 해석 패널 (현재 문장, 핵심 표현, 관용 표현)
- [x] 재생 컨트롤 (이전/일시정지/반복/다음 + 단축키 1,2,3,4)
- [x] 원문 보기 / 번역 보기 토글
- [x] 자막 싱크 오프셋 조절 (±0.5초 단위)
- [x] 자막 싱크 탭 (전체 자막 목록 + 클릭 이동)

### Phase 2 - 학습 강화
- [ ] 저장(북마크) 기능
- [ ] 드릴 시트 페이지
- [ ] 요약/퀴즈 탭 (사전 생성)
- [ ] 최근 학습 영상 목록

### Phase 3 - 고급 기능
- [ ] AI 채팅 탭 (실시간 AI 질문)
- [ ] 쉐도잉 탭 (음성 녹음 + 비교)
- [ ] 사용자 인증 및 학습 이력 저장
- [ ] Whisper API 활용 자막 없는 영상 지원

---

## 9. UI/UX 설계 가이드

### 9.1 레이아웃
- 전체 화면을 좌측(영상 약 70%) + 우측(학습 패널 약 30%) 2분할
- 반응형 지원: 모바일에서는 영상/패널 상하 배치

### 9.2 자막 오버레이
- 영상 하단에 반투명 배경의 자막 표시
- 핵심 표현: **초록색** 하이라이트 + 밑줄
- 관용 표현: **노란색** 하이라이트 + 밑줄
- 한국어 번역은 영어 원문 아래 약간 작은 폰트로 표시

### 9.3 우측 패널
- 상단: 탭 네비게이션 (문장해석 / AI / 쉐도잉 / 요약퀴즈 / 자막싱크)
- 본문: 스크롤 가능한 콘텐츠 영역
- 카드 형태의 UI로 현재 문장, 핵심 표현, 관용 표현 구분

### 9.4 다크 테마
- 기본 다크 테마 적용 (영상 학습에 적합)

---

## 10. 비기능 요구사항

| 항목 | 요구사항 |
|------|----------|
| 성능 | 이미 처리된 영상: 학습 데이터 로딩 1초 이내 |
| 초기 처리 | 새 영상 처리(자막 추출 + AI 번역/분석): 로딩 UI 표시 |
| 캐싱 | 처리된 영상은 파일로 저장되어 자동 캐싱 |
| 접근성 | 키보드 단축키 지원, 적절한 폰트 크기 |
| 호환성 | Chrome, Safari, Firefox 최신 버전 지원 |
| 보안 | AI 처리는 로컬 CLI로 수행, API 키 노출 위험 없음 |

---

## 11. 제약사항 및 리스크

| 리스크 | 대응 방안 |
|--------|----------|
| YouTube 자막 미제공 영상 | 자막 없음 안내 + Phase 3에서 Whisper API 자막 생성 |
| AI API 비용 | Claude CLI로 로컬 처리, 별도 API 키 불필요 |
| 긴 영상의 AI 처리 | 자막을 4개 청크로 분할하여 병렬 처리 (번역 4 + 분석 4 = 최대 8 프로세스) |
| YouTube iframe 제약 | YouTube IFrame Player API 공식 가이드 준수 |
| 자막 타이밍 부정확 | 자막 싱크 오프셋 조절 기능 제공 (±0.5초 단위, 구현 완료) |
| 파일 스토리지 용량 | 영상당 수십KB 수준이므로 문제 없음 |
